pipeline {
    agent any

    environment {
        EMAIL_RECIPIENT = 'afi.seif@esprit.tn'
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stages {

        stage('GIT') {

                   steps {

                       git branch: 'SeifAfi-5sae-G6',

                       url: 'https://github.com/Si-aymen/5SAE7-G6-CourZelo.git'

                  }

             }

        stage('Build') {
            steps {
                dir('backendPidev') {
                    script {
                        try {
                            sh 'mvn clean install'
                        } catch (Exception e) {
                            error "Build failed: ${e}"
                        }
                    }
                }
            }
        }

         stage('SonarQube Analysis') {
            steps {
                dir('backendPidev') {
                    sh 'mvn sonar:sonar -Dsonar.login=admin -Dsonar.password=Seif2066-2066 -Dmaven.test.skip=true'
                }
            }
        }
        stage('jUnitTest') {
            steps {
                dir('backendPidev') {
                    script {
                        try {
                            sh 'mvn test'
                        } catch (Exception e) {
                            error "Tests failed: ${e}"
                        }
                    }
                }
            }
        }

       stage('Deploy to Nexus') {
                   steps {
                       dir('backendPidev') {
                           script {
                               try {
                                   sh 'mvn deploy -s ~/.m2/settings.xml -X'
                               } catch (Exception e) {
                                   error "Deployment failed: ${e}"
                               }
                           }
                       }
                   }
               }

        stage('Build Docker Image') {
            steps {
                script {
                    echo 'Building Docker Image'
                    sh 'docker build -t seif2066/devops-integration:latest --build-arg JAR_FILE=target/devops-integration.jar -f backendPidev/Dockerfile backendPidev'
                }
            }
        }


        stage('Deploy Image to DockerHub') {
                   steps {
                       script {
                       withCredentials([string(credentialsId: 'dockerhub-pwd', variable: 'dockerhubpwd')]) {
                               sh 'docker login -u seif2066 -p ${dockerhubpwd}'
                               sh 'docker push seif2066/devops-integration'
                           }
                       }
                   }
                }

        stage('Run Docker Compose') {
            steps {
                dir('backendPidev') {
                    script {
                        try {
                            sh 'docker-compose up -d'
                        } catch (Exception e) {
                            error "Docker Compose up failed: ${e}"
                        }
                    }
                }
            }
        }


    }

    post {
        always {
            echo 'Pipeline finished.'
            junit 'backendPidev/target/surefire-reports/*.xml'
        }
        success {
            mail to: "${env.EMAIL_RECIPIENT}",
                 subject: "Pipeline Jenkins - Success - Build #${BUILD_NUMBER}",
                 body: """Pipeline Jenkins
                 Final Report: The pipeline has completed successfully.
                 Build number: ${BUILD_NUMBER}. No action required."""
        }
        failure {
            mail to: "${env.EMAIL_RECIPIENT}",
                 subject: "Pipeline Jenkins - Failure - Build #${BUILD_NUMBER}",
                 body: """Pipeline Jenkins
                 Final Report: The pipeline has failed. Build number: ${BUILD_NUMBER}.
                 Please check the logs and take necessary actions."""
            echo 'Pipeline failed. Please check the logs for details.'
        }
    }
}
